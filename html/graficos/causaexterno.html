<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Gráficos</title>
  <link rel="icon" type="logo1/png" href="../../img/l">
  <link rel="stylesheet" href="../../css/exibir.css">
  <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;700&display=swap" rel="stylesheet"/>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2"></script>
  <style>
    .filtros {
      display: flex;
      gap: 20px;
      margin-bottom: 20px;
      align-items: center;
    }

    .filtros label {
      font-size: 0.95rem;
      cursor: pointer;
    }


    canvas {
      max-width: 100%;
    }
  </style>
</head>
<body>
  <div class="titulo">
    <img src="../../img/logo2.png" alt="Logo" class="logo">
    <h1>Gráficos</h1>
    <button class="back-button" onclick="window.location.href='../../index.html';">Voltar</button>
  </div>

  <div class="menu11">
    <div class="op"><a href="total.html">Total de Chamados</a></div>
    <div class="op"><a href="externoxinterno.html">Externo x Interno</a></div>
    <div class="op"><a href="responsavel.html">Responsável</a></div>
    <div class="op"><a href="externo.html">Externo - Serviço</a></div>
    <div class="op"><a href="interno.html">Interno - Sistemas</a></div>
    <div class="op selected"><a href="causaexterno.html">Causas</a></div>
  </div>

  <div class="main-content">
    <h2>Causas por Sprint</h2>

    <!-- Radio buttons posicionados dentro do container -->
    <div class="filtros">
      <strong>Selecionar Fonte:</strong>
      <label><input type="radio" name="fonte" value="Externo"checked> Externo</label>
	        <label><input type="radio" name="fonte" value="Interno" > Interno</label>
    </div>

    <canvas id="chart"></canvas>
  </div>

  <script>
    const sheetId = '1vzQ932VhryQLJV7j1aMYsOYLqBUKifJ_E9SKXrzbkD8';
    const apiKey = 'AIzaSyA-aZjrMoRGcyuIlO-RbtaaFOZRHA4YGww';
    const chartCanvas = document.getElementById('chart').getContext('2d');
    let chartInstance;

    document.querySelectorAll('input[name="fonte"]').forEach(radio => {
      radio.addEventListener('change', () => {
        carregarDados(radio.value);
      });
    });

    async function carregarDados(abaSelecionada = 'Interno') {
      const url = `https://sheets.googleapis.com/v4/spreadsheets/${sheetId}/values/${abaSelecionada}?key=${apiKey}`;
      const response = await fetch(url);
      const json = await response.json();
      const valores = json.values;

      const headers = valores[0];
      const sprintIdx = headers.findIndex(h => h.trim().toLowerCase() === "sprint");
      const causaIdx = headers.findIndex(h => h.trim().toLowerCase() === "causa");

      const contagem = {};
      valores.slice(1).forEach(row => {
        const sprint = row[sprintIdx]?.trim();
        const causa = row[causaIdx]?.trim();
        if (!sprint || !causa) return;
        if (!contagem[sprint]) contagem[sprint] = {};
        if (!contagem[sprint][causa]) contagem[sprint][causa] = 0;
        contagem[sprint][causa]++;
      });

      const sprints = Object.keys(contagem).sort();
      const causas = Array.from(new Set(sprints.flatMap(s => Object.keys(contagem[s])))).sort();

      const datasets = causas.map(causa => ({
        label: causa,
        data: sprints.map(sprint => {
          const total = Object.values(contagem[sprint]).reduce((a, b) => a + b, 0);
          const valor = contagem[sprint][causa] || 0;
          return {
            x: sprint,
            y: (valor / total * 100),
            raw: valor
          };
        }),
        backgroundColor: corFixa(causa)
      }));

      renderChart(sprints, datasets);
    }

    function renderChart(sprints, datasets) {
      if (chartInstance) {
        chartInstance.destroy();
      }

      chartInstance = new Chart(chartCanvas, {
        type: 'bar',
        data: {
          labels: sprints,
          datasets: datasets
        },
        options: {
          responsive: true,
          plugins: {
            legend: {
              position: 'top'
            },
            datalabels: {
              color: 'black',
              anchor: 'center',
              align: 'center',
              formatter: function(value) {
                if (value.raw === 0) return '';
                return `${value.raw} (${value.y.toFixed(1)}%)`;
              }
            }
          },
          scales: {
            x: { stacked: true },
            y: {
              stacked: true,
              beginAtZero: true,
              max: 100,
              title: {
                display: true,
                text: 'Porcentagem (%)'
              }
            }
          }
        },
        plugins: [ChartDataLabels]
      });
    }

function corFixa(causa) {
  const cores = {
    "Dúvida de Uso": "#5DADE2",              // Azul petróleo
    "Erro Humano": "#F5B041",               // Laranja suave
    "Erro do Sistema": "#EC7063",           // Vermelho coral
    "Inconsistência Temporária": "#AF7AC5", // Roxo lavanda
    "Solicitação Operacional": "#58D68D"    // Verde médio
  };
  return cores[causa] || "#BDBDBD"; // cinza padrão se não bater
}


    carregarDados(); // Inicial
  </script>
</body>
</html>
